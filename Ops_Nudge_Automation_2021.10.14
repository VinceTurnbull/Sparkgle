with Create_Flags as(

select startmonth
, submissionmonth
, startweek
, submissionweek
, palcategory
, ruleruntiming
, clinicalservicename
, lineofbusinesstype
, policytype
, authstatus
, withdrawnreason
, units 

-- add info about RN MD Peer Reviews
, (case when nursereviewed = 'True' then 1 else 0 end) as RN_review_flag
, (case when mdreviewed = 'True' then 1 else 0 end) as MD_review_flag
, (case when peerreviewed = 'True' then 1 else 0 end) as Peer_review_flag


-- flags for SOS nudges
, (case when (palcategory LIKE '%Spinal fusion, decompression, kyphoplasty and vertebroplasty%' 
             OR palcategory LIKE '%Orthopedic Surgeries: Hip, Knee and Shoulder Arthroplasty%') 
             AND nudgeinhuman = 'True'
             AND (nudgetypes LIKE '%SERVICES_ON_REQUEST%' 
                  OR nudgetypes LIKE '%SITE_OF_SERVICE%') Then 1 else 0 end) as Count_SoS_OPs_Nudges
                 
, (case when (palcategory LIKE '%Spinal fusion, decompression, kyphoplasty and vertebroplasty%' 
             OR palcategory LIKE '%Orthopedic Surgeries: Hip, Knee and Shoulder Arthroplasty%') 
             AND nudgeinhuman = 'True'
             AND (nudgetypes LIKE '%SERVICES_ON_REQUEST%' 
                  OR nudgetypes LIKE '%SITE_OF_SERVICE%') 
             AND authstatus = 'APPROVED' Then 1 else 0 end) as Count_SoS_OPs_Nudges_ApprovedOnly


, (case when (palcategory LIKE '%Spinal fusion, decompression, kyphoplasty and vertebroplasty%' 
             OR palcategory LIKE '%Orthopedic Surgeries: Hip, Knee and Shoulder Arthroplasty%') 
             AND nudgeinhuman = 'True'
             AND (nudgetypes LIKE '%SERVICES_ON_REQUEST%' 
                  OR nudgetypes LIKE '%SITE_OF_SERVICE%') 
             AND authstatus = 'APPROVED' 
             AND (encountertype = 'OUTPATIENT') Then 1 else 0 end) as Successful_SoS_OPs_Nudges_ApprovedOnly


-- flags for Unit based nudges
, (case when nudgeinhuman = 'True'
             AND (nudgetypes LIKE '%UNITS%') Then 1 else 0 end) as Count_Units_OPs_Nudges
 
 , (case when nudgeinhuman = 'True'
             AND nudgetypes LIKE '%UNITS%' 
             AND authstatus = 'APPROVED' Then 1 else 0 end) as Count_Units_OPs_Nudges_ApprovedOnly


, (case  when nudgeinhuman = 'True'
             AND nudgetypes LIKE '%UNITS%'
             AND authstatus = 'APPROVED' 
             AND (cast(units as integer) < cast(historical_units as integer) ) Then 1 else 0 end) as Successful_Units_OPs_Nudges_ApprovedOnly

, (case  when nudgeinhuman = 'True'
             AND nudgetypes LIKE '%UNITS%'
             AND authstatus = 'APPROVED'
             AND (cast(units as integer) < cast(historical_units as integer) ) Then (cast(historical_units as integer) - cast(units as integer)) else 0 end) as Reduced_Units_Ops_Nudges
  
  
, (case  when (nudgeinhuman = 'True'
             AND nudgetypes LIKE '%UNITS%'
             AND authstatus = 'APPROVED' 
             AND (cast(units as integer) < cast(historical_units as integer) ) 
             AND (cast(historical_units as integer) - cast(units as integer)) < 60)  Then (cast(historical_units as integer) - cast(units as integer)) 
         when (nudgeinhuman = 'True'
             AND nudgetypes LIKE '%UNITS%'
             AND authstatus = 'APPROVED'
             AND (cast(units as integer) < cast(historical_units as integer) ) 
             AND (cast(historical_units as integer) - cast(units as integer)) > 60) Then 60
         else 0 end) as Reduced_Units_Ops_Nudges_Cap60


-- time based nudges
, (case when nudgeinhuman = 'True'
             AND (nudgetypes LIKE '%TIMING%'OR nudgetypes LIKE '%FREQUENCY%') Then 1 else 0 end) as Count_Timing_OPs_Nudges
 

, (case  when nudgeinhuman = 'True'
             AND (nudgetypes LIKE '%TIMING%'OR nudgetypes LIKE '%FREQUENCY%')
             AND (authstatus = 'APPROVED' AND (historical_startdate < startdate)) Then 1 else 0 end) as Successful_Timing_OPs_Nudges_ApprovedOnly
 
 
  
  
   

from testdb.impact_model )



-- summary
select startmonth
, submissionmonth
, startweek
, submissionweek
, palcategory
, ruleruntiming
, clinicalservicename
, lineofbusinesstype
, policytype
, authstatus
, withdrawnreason
, sum(cast(units as integer)) as units
, count(*) as auth_count
, sum(RN_review_flag) as RN_review_flag
, sum(MD_review_flag) as MD_review_flag
, sum(Peer_review_flag) as Peer_review_flag
, sum(Count_SoS_OPs_Nudges) as Count_SoS_OPs_Nudges
, sum(Count_SoS_OPs_Nudges_ApprovedOnly) as Count_SoS_OPs_Nudges_ApprovedOnly
, sum(Successful_SoS_OPs_Nudges_ApprovedOnly) as Successful_SoS_OPs_Nudges_ApprovedOnly
, sum(Count_Units_OPs_Nudges) as Count_Units_OPs_Nudges
, sum(Count_Units_OPs_Nudges_ApprovedOnly) as Count_Units_OPs_Nudges_ApprovedOnly
, sum(Successful_Units_OPs_Nudges_ApprovedOnly) as Successful_Units_OPs_Nudges_ApprovedOnly
, sum(Reduced_Units_Ops_Nudges) as Reduced_Units_Ops_Nudges
, sum(Reduced_Units_Ops_Nudges_Cap60) as Reduced_Units_Ops_Nudges_Cap60
, sum(Count_Timing_OPs_Nudges) as Count_Timing_OPs_Nudges
, sum(Successful_Timing_OPs_Nudges_ApprovedOnly) as Successful_Timing_OPs_Nudges_ApprovedOnly
from Create_Flags
group by 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11
